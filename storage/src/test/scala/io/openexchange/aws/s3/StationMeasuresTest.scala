package io.openexchange.aws.s3

import java.io.ByteArrayInputStream

import com.amazonaws.services.s3.AmazonS3
import com.amazonaws.services.s3.internal.InputSubstream
import com.amazonaws.services.s3.model.{SelectObjectContentEvent, SelectObjectContentEventStream, SelectObjectContentRequest, SelectObjectContentResult}
import org.scalamock.matchers.Matchers
import org.scalamock.scalatest.MockFactory
import org.scalatest.flatspec.AnyFlatSpec

class StationMeasuresTest extends AnyFlatSpec with MockFactory with Matchers {

  private val amazonS3Mock = mock[AmazonS3]
  private val s3Client = new S3Client(amazonS3Mock)
  private val stationStore = S3StationMeasures(s3Client, "testBucket", "testKey")

  "A StationStore" should "trigger callback twice" in {

    val payload = Array[Byte](0, 0, 0, -121, 0, 0, 0, 85, 125, -27, 22, -112, 13, 58, 109, 101, 115, 115, 97, 103, 101, 45,
      116, 121, 112, 101, 7, 0, 5, 101, 118, 101, 110, 116, 11, 58, 101, 118, 101, 110, 116, 45, 116, 121, 112, 101, 7, 0, 7, 82,
      101, 99, 111, 114, 100, 115, 13, 58, 99, 111, 110, 116, 101, 110, 116, 45, 116, 121, 112, 101, 7, 0, 24, 97, 112, 112, 108,
      105, 99, 97, 116, 105, 111, 110, 47, 111, 99, 116, 101, 116, 45, 115, 116, 114, 101, 97, 109, 123, 34, 73, 68, 34, 58, 34,
      51, 34, 44, 34, 76, 65, 83, 84, 95, 78, 65, 77, 69, 34, 58, 34, 82, 105, 99, 104, 97, 114, 100, 115, 34, 125, 10, -13, 46,
      -38, -82, 0, 0, 0, -48, 0, 0, 0, 67, 3, 2, -80, 26, 13, 58, 109, 101, 115, 115, 97, 103, 101, 45, 116, 121, 112, 101, 7, 0,
      5, 101, 118, 101, 110, 116, 11, 58, 101, 118, 101, 110, 116, 45, 116, 121, 112, 101, 7, 0, 5, 83, 116, 97, 116, 115, 13, 58,
      99, 111, 110, 116, 101, 110, 116, 45, 116, 121, 112, 101, 7, 0, 8, 116, 101, 120, 116, 47, 120, 109, 108, 60, 83, 116, 97,
      116, 115, 32, 120, 109, 108, 110, 115, 61, 34, 34, 62, 60, 66, 121, 116, 101, 115, 83, 99, 97, 110, 110, 101, 100, 62, 49, 50,
      57, 60, 47, 66, 121, 116, 101, 115, 83, 99, 97, 110, 110, 101, 100, 62, 60, 66, 121, 116, 101, 115, 80, 114, 111, 99, 101, 115,
      115, 101, 100, 62, 49, 50, 57, 60, 47, 66, 121, 116, 101, 115, 80, 114, 111, 99, 101, 115, 115, 101, 100, 62, 60, 66, 121, 116,
      101, 115, 82, 101, 116, 117, 114, 110, 101, 100, 62, 51, 52, 60, 47, 66, 121, 116, 101, 115, 82, 101, 116, 117, 114, 110, 101, 100,
      62, 60, 47, 83, 116, 97, 116, 115, 62, -106, -63, 3, -102, 0, 0, 0, 56, 0, 0, 0, 40, -63, -58, -124, -44, 13, 58, 109, 101, 115,
      115, 97, 103, 101, 45, 116, 121, 112, 101, 7, 0, 5, 101, 118, 101, 110, 116, 11, 58, 101, 118, 101, 110, 116, 45, 116, 121, 112,
      101, 7, 0, 3, 69, 110, 100, -49, -105, -45, -110, 0, 0, 0, 110, 0, 0, 0, 85, 88, 33, -77, 62, 13, 58, 109, 101, 115, 115, 97, 103,
      101, 45, 116, 121, 112, 101, 7, 0, 5, 101, 118, 101, 110, 116, 11, 58, 101, 118, 101, 110, 116, 45, 116, 121, 112, 101, 7, 0, 7,
      82, 101, 99, 111, 114, 100, 115, 13, 58, 99, 111, 110, 116, 101, 110, 116, 45, 116, 121, 112, 101, 7, 0, 24, 97, 112, 112, 108,
      105, 99, 97, 116, 105, 111, 110, 47, 111, 99, 116, 101, 116, 45, 115, 116, 114, 101, 97, 109, 50, 44, 77, 105, 108, 108, 101,
      114, 10, -100, -6, 78, -76, 0, 0, 0, -49, 0, 0, 0, 67, -31, -78, -80, 73, 13, 58, 109, 101, 115, 115, 97, 103, 101, 45, 116, 121,
      112, 101, 7, 0, 5, 101, 118, 101, 110, 116, 11, 58, 101, 118, 101, 110, 116, 45, 116, 121, 112, 101, 7, 0, 5, 83, 116, 97, 116,
      115, 13, 58, 99, 111, 110, 116, 101, 110, 116, 45, 116, 121, 112, 101, 7, 0, 8, 116, 101, 120, 116, 47, 120, 109, 108, 60, 83,
      116, 97, 116, 115, 32, 120, 109, 108, 110, 115, 61, 34, 34, 62, 60, 66, 121, 116, 101, 115, 83, 99, 97, 110, 110, 101, 100,
      62, 52, 49, 53, 60, 47, 66, 121, 116, 101, 115, 83, 99, 97, 110, 110, 101, 100, 62, 60, 66, 121, 116, 101, 115, 80, 114, 111,
      99, 101, 115, 115, 101, 100, 62, 52, 49, 53, 60, 47, 66, 121, 116, 101, 115, 80, 114, 111, 99, 101, 115, 115, 101, 100, 62,
      60, 66, 121, 116, 101, 115, 82, 101, 116, 117, 114, 110, 101, 100, 62, 57, 60, 47, 66, 121, 116, 101, 115, 82, 101, 116, 117,
      114, 110, 101, 100, 62, 60, 47, 83, 116, 97, 116, 115, 62, -72, -54, 60, -55, 0, 0, 0, 56, 0, 0, 0, 40, -63, -58, -124, -44,
      13, 58, 109, 101, 115, 115, 97, 103, 101, 45, 116, 121, 112, 101, 7, 0, 5, 101, 118, 101, 110, 116, 11, 58, 101, 118, 101,
      110, 116, 45, 116, 121, 112, 101, 7, 0, 3, 69, 110, 100, -49, -105, -45, -110)
    val selectObjectContentEventStream = new SelectObjectContentEventStream(new InputSubstream(new ByteArrayInputStream(payload), 0, payload.length, false))
    val selectObjectContentResult = new SelectObjectContentResult().withPayload(selectObjectContentEventStream)
    (amazonS3Mock.selectObjectContent(_: SelectObjectContentRequest)).expects(*).returning(selectObjectContentResult).once()

    var count = 0
    stationStore.search("select * from stations", (event: SelectObjectContentEvent.RecordsEvent) => {
      println(event)
      count += 1
    })
    assert(count == 2)
  }

}
